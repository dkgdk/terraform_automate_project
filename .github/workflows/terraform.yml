name: Terraform Workflow

on:
  workflow_dispatch:
    inputs:
      recipient_email:
        description: 'Email address to receive the result notification'
        required: true
        default: 'durgeshgupt.dg@gmail.com'

jobs:
  terraform:
    runs-on: ubuntu-latest

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: "ap-south-1"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5

      - name: Terraform Init
        id: init
        run: terraform init

      - name: Terraform Plan
        id: plan
        run: terraform plan -out=tfplan

      - name: Terraform Apply
        if: success()
        id: apply
        run: terraform apply -auto-approve tfplan

      # -------------------------------
      # Email Notification Section
      # -------------------------------

      - name: Set up Python for email
        if: always()
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install python deps and send email
        if: always()
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          RECIPIENT: ${{ github.event.inputs.recipient_email }}
        run: |
          python -m pip install --upgrade pip
          python -m pip install email-validator
          python - <<'PY'
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart

smtp_server = "${{ env.SMTP_SERVER }}"
smtp_port = int("${{ env.SMTP_PORT }}")
smtp_user = "${{ env.SMTP_USER }}"
smtp_password = "${{ env.SMTP_PASSWORD }}"
recipient = "${{ env.RECIPIENT }}"

subject = "Terraform Execution Completed"
body = f"""
Hello,

The Terraform workflow finished running.

✅ Init:  ${{ steps.init.outcome }}
✅ Plan:  ${{ steps.plan.outcome }}
✅ Apply: ${{ steps.apply.outcome }}

Regards,
GitHub Actions Bot
"""

msg = MIMEMultipart()
msg["From"] = smtp_user
msg["To"] = recipient
msg["Subject"] = subject
msg.attach(MIMEText(body, "plain"))

try:
    with smtplib.SMTP(smtp_server, smtp_port) as server:
        server.starttls()
        server.login(smtp_user, smtp_password)
        server.sendmail(smtp_user, recipient, msg.as_string())
    print("Email sent successfully!")
except Exception as e:
    print(f"Error sending email: {e}")
PY
