name: Terraform Deploy

on:
  workflow_dispatch:
    inputs:
      destroy:
        description: "Destroy infra? true/false"
        required: true
        default: "false"
      resource:
        description: "Resource to apply (ec2/s3)"
        required: true
        default: "ec2"
      emails:
        description: "Comma separated email list"
        required: true
        default: "admin@example.com"

jobs:
  terraform:
    runs-on: ubuntu-latest
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: "ap-south-1"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set script variables
        id: vars
        run: |
          echo "DESTROY=${{ github.event.inputs.destroy }}" >> $GITHUB_ENV
          echo "RESOURCE=${{ github.event.inputs.resource }}" >> $GITHUB_ENV
          echo "EMAILS=${{ github.event.inputs.emails }}" >> $GITHUB_ENV

      - name: Select resource folder
        run: |
          if [ "$RESOURCE" = "ec2" ]; then DIR="ec2"; fi
          if [ "$RESOURCE" = "s3" ]; then DIR="s3"; fi
          echo "DIR=$DIR" >> $GITHUB_ENV

      - name: Terraform Init
        working-directory: ${{ github.workspace }}/${{ env.DIR }}
        run: terraform init -input=false

      - name: Terraform Apply/Destroy
        working-directory: ${{ github.workspace }}/${{ env.DIR }}
        run: |
          if [ "$DESTROY" = "true" ]; then
            terraform destroy -auto-approve
          else
            terraform apply -auto-approve
          fi

      - name: Send Email Notification
        run: |
          STATUS=$([ "$DESTROY" = "true" ] && echo "Destroyed" || echo "Applied")
          SUBJECT="Terraform $STATUS - $RESOURCE"
          BODY="Terraform task finished.\n\nResource: $RESOURCE\nStatus: $STATUS\nRepo: $GITHUB_REPOSITORY\nRun ID: $GITHUB_RUN_ID"

          echo "Sending email to: $EMAILS"
          IFS=',' read -ra MAILS <<< "$EMAILS"
          for m in "${MAILS[@]}"; do
            echo -e "$BODY" | mail -s "$SUBJECT" "$m"
          done
