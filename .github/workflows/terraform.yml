name: Terraform Deploy

on:
  workflow_dispatch:
    inputs:
      destroy:
        description: "Destroy resources instead of creating?"
        required: true
        default: "false"
        type: choice
        options:
          - "false"
          - "true"
      resource:
        description: "Which resources to deploy/destroy?"
        required: true
        default: "all"
        type: choice
        options:
          - ec2
          - s3
          - all
      backend_bucket:
        description: "S3 bucket for tfstate (default: bucketfortfstatestorage)"
        required: false
        default: "bucketfortfstatestorage"
      recipient_email:
        description: "Email to send deployment results to"
        required: true

permissions:
  contents: read

jobs:
  terraform:
    runs-on: ubuntu-latest

    env:
      TF_IN_AUTOMATION: "true"
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: "ap-south-1"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.6"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-south-1

      - name: Prepare parameters
        id: params
        run: |
          echo "destroy=${{ github.event.inputs.destroy }}" >> $GITHUB_OUTPUT
          echo "resource=${{ github.event.inputs.resource }}" >> $GITHUB_OUTPUT
          echo "backend_bucket=${{ github.event.inputs.backend_bucket }}" >> $GITHUB_OUTPUT
          echo "recipient_email=${{ github.event.inputs.recipient_email }}" >> $GITHUB_OUTPUT

      - name: Run Terraform per module
        id: tf_run
        run: |
          set -euo pipefail
          DESTROY="${{ steps.params.outputs.destroy }}"
          RESOURCE="${{ steps.params.outputs.resource }}"
          BUCKET="${{ steps.params.outputs.backend_bucket }}"

          MODULES=()

          if [ "$RESOURCE" = "ec2" ] || [ "$RESOURCE" = "all" ]; then
            MODULES+=("ec2")
          fi
          if [ "$RESOURCE" = "s3" ] || [ "$RESOURCE" = "all" ]; then
            MODULES+=("s3")
          fi

          for m in "${MODULES[@]}"; do
            echo "ðŸš€ Processing module: $m"

            cat > "$m/backend.hcl" <<EOF
            bucket = "$BUCKET"
            key    = "$m/terraform.tfstate"
            region = "ap-south-1"
            encrypt = true
            EOF

            cd "$m"
            terraform init -backend-config=backend.hcl

            if [ "$DESTROY" = "true" ]; then
              terraform destroy -auto-approve || true
            else
              terraform apply -auto-approve
            fi

            terraform output -json > "../${m}_outputs.json" || true
            cd ..
          done

      - name: Send Email with results
        if: always()
        run: |
          chmod +x scripts/send_mail.sh
          ./scripts/send_mail.sh
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          RECIPIENT: ${{ steps.params.outputs.recipient_email }}
