name: Terraform Deploy

on:
  workflow_dispatch:
    inputs:
      destroy:
        description: "Destroy resources? (true/false)"
        required: true
        default: "false"
      resource:
        description: "Resource type (ec2/s3/all)"
        required: true
        default: "all"
      backend_bucket:
        description: "Terraform backend S3 bucket"
        required: true
        default: "bucketfortfstatestorage"

jobs:
  terraform:
    runs-on: ubuntu-latest
    env:
      DESTROY: ${{ github.event.inputs.destroy }}
      RESOURCE: ${{ github.event.inputs.resource }}
      BACKEND_BUCKET: ${{ github.event.inputs.backend_bucket }}

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-south-1

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2

    - name: Terraform Init
      run: |
        terraform init -backend-config="bucket=$BACKEND_BUCKET" -input=false

    - name: Terraform Plan
      run: terraform plan -input=false

    - name: Terraform Apply or Destroy
      run: |
        if [[ "$DESTROY" == "true" ]]; then
          echo "ðŸ›‘ Destroying resources..."
          terraform destroy -auto-approve
        else
          echo "ðŸš€ Deploying resources..."
          terraform apply -auto-approve
        fi

    - name: Save Terraform Outputs
      run: |
        mkdir -p outputs
        terraform output -json > outputs/terraform_outputs.json

    - name: Make Mail Script Executable
      run: chmod +x scripts/send_mail.sh

    - name: Send Email Notification
      env:
        SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
        SMTP_PORT: ${{ secrets.SMTP_PORT }}
        SMTP_USER: ${{ secrets.SMTP_USER }}
        SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        RECIPIENT: ${{ secrets.RECIPIENT }}
      run: |
        ./scripts/send_mail.sh "Terraform Finished" outputs/terraform_outputs.json
