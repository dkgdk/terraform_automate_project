name: Terraform Deploy

on:
  workflow_dispatch:
    inputs:
      destroy:
        description: "Destroy resources?"
        required: true
        default: "false"
        type: boolean
      resource:
        description: "Resource to apply/destroy"
        required: true
        default: "all"
        type: choice
        options:
          - ec2
          - s3
          - all
      backend_bucket:
        description: "S3 bucket name for tfstate"
        required: true
        default: "bucketfortfstatestorage"
      recipient_email:
        description: "Email to send deployment result"
        required: true
        type: string

permissions:
  contents: read

jobs:
  terraform:
    runs-on: ubuntu-latest
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ap-south-1
      TF_IN_AUTOMATION: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5

      - name: Set execution params
        id: params
        run: |
          echo "DESTROY=${{ github.event.inputs.destroy }}" >> $GITHUB_ENV
          echo "RESOURCE=${{ github.event.inputs.resource }}" >> $GITHUB_ENV
          echo "BUCKET=${{ github.event.inputs.backend_bucket }}" >> $GITHUB_ENV
          echo "RECIPIENT=${{ github.event.inputs.recipient_email }}" >> $GITHUB_ENV

      - name: Run Terraform
        id: run_tf
        run: |
          set -euo pipefail
          echo "Destroy: $DESTROY"
          echo "Resource: $RESOURCE"
          echo "Backend bucket: $BUCKET"

          dirs=()
          if [ "$RESOURCE" = "ec2" ] || [ "$RESOURCE" = "all" ]; then dirs+=("ec2"); fi
          if [ "$RESOURCE" = "s3" ] || [ "$RESOURCE" = "all" ]; then dirs+=("s3"); fi

          for d in "${dirs[@]}"; do
            echo "Working on: $d"
            cat > $d/backend.hcl <<EOF
            bucket  = "$BUCKET"
            key     = "$d/terraform.tfstate"
            region  = "ap-south-1"
            encrypt = true
            EOF
            cd $d
            terraform init -backend-config=backend.hcl
            if [ "$DESTROY" = "true" ]; then
              terraform destroy -auto-approve
            else
              terraform apply -auto-approve
            fi
            terraform output -json > ../${d}_outputs.json || true
            cd ..
          done

      - name: Make email script executable
        run: chmod +x scripts/send_mail.sh

      - name: Send email
        if: always()
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          RECIPIENT: ${{ github.event.inputs.recipient_email }}
        run: scripts/send_mail.sh
