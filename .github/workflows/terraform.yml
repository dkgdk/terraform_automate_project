name: Terraform Deploy

on:
  workflow_dispatch:
    inputs:
      resource:
        type: choice
        description: "Select resource to deploy"
        required: true
        options:
          - ec2
          - s3
      destroy:
        type: choice
        description: "Destroy instead of apply?"
        required: true
        options:
          - "false"
          - "true"
      emails:
        description: "Enter comma separated email list"
        required: true
        default: "admin@example.com"

jobs:
  terraform:
    runs-on: ubuntu-latest
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: "ap-south-1"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set environment variables
        run: |
          echo "RESOURCE=${{ github.event.inputs.resource }}" >> $GITHUB_ENV
          echo "DESTROY=${{ github.event.inputs.destroy }}" >> $GITHUB_ENV
          echo "EMAILS='${{ github.event.inputs.emails }}'" >> $GITHUB_ENV

      - name: Install mailutils
        run: sudo apt-get update && sudo apt-get install -y mailutils

      - name: Terraform Init
        working-directory: ${{ github.workspace }}/${{ env.RESOURCE }}
        run: terraform init -input=false

      - name: Terraform Apply or Destroy
        working-directory: ${{ github.workspace }}/${{ env.RESOURCE }}
        run: |
          if [ "$DESTROY" = "true" ]; then
            terraform destroy -auto-approve
            STATUS="Destroyed"
          else
            terraform apply -auto-approve
            STATUS="Applied"
          fi
          echo "STATUS=$STATUS" >> $GITHUB_ENV

      - name: Send Email Notification
        run: |
          SUBJECT="Terraform $STATUS - $RESOURCE"
          BODY="Terraform completed successfully.

          Resource: $RESOURCE
          Action: $STATUS
          Repository: $GITHUB_REPOSITORY
          Run ID: $GITHUB_RUN_ID"

          echo "Sending email to: $EMAILS"
          IFS=',' read -ra MAILS <<< "$EMAILS"
          for m in "${MAILS[@]}"; do
            echo -e "$BODY" | mail -s "$SUBJECT" "$m"
          done
