name: Terraform Deploy

on:
  workflow_dispatch:
    inputs:
      destroy:
        description: "Destroy resources?"
        required: true
        default: "false"
        type: boolean
      resource:
        description: "Which resource to act on"
        required: true
        default: "all"
        type: choice
        options:
          - ec2
          - s3
          - all
      recipient_email:
        description: "Email to receive Terraform results"
        required: true
        type: string

permissions:
  contents: read

jobs:
  terraform:
    runs-on: ubuntu-latest
    env:
      TF_IN_AUTOMATION: true
      BACKEND_BUCKET: bucketfortfstatestorage

    steps:
      - uses: actions/checkout@v4

      - name: Debug repo tree
        run: ls -R .

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.7"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-south-1

      - name: Read workflow inputs
        id: params
        run: |
          echo "destroy=${{ github.event.inputs.destroy }}" >> $GITHUB_OUTPUT
          echo "resource=${{ github.event.inputs.resource }}" >> $GITHUB_OUTPUT
          echo "recipient_email=${{ github.event.inputs.recipient_email }}" >> $GITHUB_OUTPUT

      - name: Run Terraform
        id: run_tf
        run: |
          set -euo pipefail
          DESTROY="${{ steps.params.outputs.destroy }}"
          RESOURCE="${{ steps.params.outputs.resource }}"
          EMAIL="${{ steps.params.outputs.recipient_email }}"
          BUCKET="$BACKEND_BUCKET"

          echo "Destroy: $DESTROY"
          echo "Resource: $RESOURCE"
          echo "Backend bucket: $BUCKET"
          echo "Email: $EMAIL"

          apply_dirs=()
          if [ "$RESOURCE" = "ec2" ] || [ "$RESOURCE" = "all" ]; then
            apply_dirs+=("ec2")
          fi
          if [ "$RESOURCE" = "s3" ] || [ "$RESOURCE" = "all" ]; then
            apply_dirs+=("s3")
          fi

          for d in "${apply_dirs[@]}"; do
            echo "ðŸ”¹ Working on module: $d"

            cat > $d/backend.hcl <<EOF
          bucket = "${BUCKET}"
          key    = "${d}/terraform.tfstate"
          region = "ap-south-1"
          encrypt = true
          EOF

            cd $d
            terraform init -backend-config=backend.hcl -input=false

            if [ "$DESTROY" = "true" ]; then
              terraform destroy -auto-approve
            else
              terraform apply -auto-approve
            fi

            terraform output -json > ../${d}_outputs.json || true
            cd ..
          done

      - name: Make send_mail.sh executable
        run: chmod +x scripts/send_mail.sh

      - name: Send email with results
        if: always()
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          RECIPIENT: ${{ github.event.inputs.recipient_email }}
        run: |
          ./scripts/send_mail.sh
