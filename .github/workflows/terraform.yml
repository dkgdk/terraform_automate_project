name: Terraform Workflow

on:
  workflow_dispatch:
    inputs:
      destroy:
        type: choice
        description: "Destroy resources?"
        default: "no"
        options:
          - "no"
          - "yes"

      resource:
        type: choice
        description: "Select resource type"
        default: "all"
        options:
          - "all"
          - "ec2"
          - "s3"

      recipient_email:
        description: "Email to receive results"
        required: true
        default: "durgeshgupt.dg@gmail.com"

jobs:
  terraform:
    runs-on: ubuntu-latest
    
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: "ap-south-1"
      BACKEND_BUCKET: "bucketfortfstatestorage"
      BACKEND_KEY: "terraform.tfstate"
      BACKEND_DYNAMODB: "terraform-lock-table"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Show Selected Inputs
        run: |
          echo "Destroy: ${{ github.event.inputs.destroy }}"
          echo "Resource: ${{ github.event.inputs.resource }}"
          echo "Backend bucket: $BACKEND_BUCKET"

      ############################################################
      # Check if Terraform State Exists in S3
      ############################################################
      - name: Check S3 State File
        id: check_state
        run: |
          echo "Checking for existing Terraform state in S3..."
          if aws s3 ls s3://$BACKEND_BUCKET/$BACKEND_KEY; then
            echo "state_exists=true" >> $GITHUB_ENV
            echo "âœ… State file found in S3"
          else
            echo "state_exists=false" >> $GITHUB_ENV
            echo "âš ï¸ No state file found in S3 â€” new deployment will be created"
          fi

      ############################################################
      # Terraform Init (S3 Backend)
      ############################################################
      - name: Terraform Init (S3 Backend)
        run: |
          terraform init -input=false \
            -backend-config="bucket=$BACKEND_BUCKET" \
            -backend-config="key=$BACKEND_KEY" \
            -backend-config="region=$AWS_REGION" \
            -backend-config="dynamodb_table=$BACKEND_DYNAMODB" \
            -backend-config="encrypt=true"

      ############################################################
      # Terraform Plan / Apply / Destroy
      ############################################################
      - name: Terraform Plan
        id: plan
        run: terraform plan -out=tfplan

      - name: Terraform Apply (Create or Update)
        if: env.state_exists == 'true' && github.event.inputs.destroy == 'no'
        run: |
          echo "ðŸŸ¢ Updating existing infrastructure..."
          terraform apply -auto-approve tfplan

      - name: Terraform Apply (First Time)
        if: env.state_exists == 'false' && github.event.inputs.destroy == 'no'
        run: |
          echo "ðŸŸ¢ Creating new infrastructure..."
          terraform apply -auto-approve tfplan

      - name: Terraform Destroy
        if: github.event.inputs.destroy == 'yes'
        run: |
          echo "ðŸ§¨ Destroying all Terraform-managed resources..."
          terraform destroy -auto-approve

      ############################################################
      # Collect Terraform Outputs
      ############################################################
      - name: Collect Resource Outputs
        if: github.event.inputs.destroy == 'no'
        id: outputs
        run: |
          echo "Collecting Terraform outputs..."
          terraform output -json > tf_outputs.json
          cat tf_outputs.json
          echo "TF_OUTPUTS_JSON=$(cat tf_outputs.json | base64 -w 0)" >> $GITHUB_ENV

      ############################################################
      # Upload PEM File as Artifact (if exists)
      ############################################################
      - name: Upload PEM Key as Artifact
        if: github.event.inputs.destroy == 'no'
        uses: actions/upload-artifact@v4
        with:
          name: ec2-private-key
          path: ./tf-key.pem
          if-no-files-found: ignore

      ############################################################
      # EMAIL NOTIFICATION
      ############################################################
      - name: Send Email Results
        if: always()
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          RECIPIENT: ${{ github.event.inputs.recipient_email }}
          TF_STATUS: ${{ job.status }}
          TF_OUTPUTS_JSON: ${{ env.TF_OUTPUTS_JSON }}
        run: |
          echo "Sending email to $RECIPIENT..."
          python3 - <<EOF
          import smtplib, os, json, base64
          from email.mime.text import MIMEText

          smtp_server = os.getenv("SMTP_SERVER")
          smtp_port = int(os.getenv("SMTP_PORT"))
          smtp_user = os.getenv("SMTP_USER")
          smtp_password = os.getenv("SMTP_PASSWORD")
          recipient = os.getenv("RECIPIENT")
          status = os.getenv("TF_STATUS")

          # Decode Terraform outputs
          tf_outputs_json = os.getenv("TF_OUTPUTS_JSON")
          if tf_outputs_json:
              outputs = json.loads(base64.b64decode(tf_outputs_json))
          else:
              outputs = {}

          details = ""
          for key, val in outputs.items():
              details += f"{key}: {val.get('value', val)}\\n"

          body = f"""
          Terraform Workflow Finished

          Destroy:  ${{ github.event.inputs.destroy }}
          Resource: ${{ github.event.inputs.resource }}
          Status:   {status}

          Resource Details:
          -----------------
          {details or "No outputs available."}

          âœ… PEM private key securely stored as workflow artifact.
          Go to GitHub Actions â†’ Artifacts â†’ ec2-private-key to download.

          Regards,
          GitHub Actions Bot
          """

          msg = MIMEText(body)
          msg["Subject"] = f"Terraform Result - {status.upper()}"
          msg["From"] = smtp_user
          msg["To"] = recipient

          try:
              with smtplib.SMTP(smtp_server, smtp_port) as server:
                  server.starttls()
                  server.login(smtp_user, smtp_password)
                  server.sendmail(smtp_user, recipient, msg.as_string())
              print("âœ… Email sent successfully!")
          except Exception as e:
              print(f"âŒ Email sending failed: {e}")
          EOF
