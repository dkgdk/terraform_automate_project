name: Terraform deploy

on:
  workflow_dispatch:
    inputs:
      destroy:
        description: 'Destroy resources?'
        required: true
        default: 'false'
        type: boolean
      resource:
        description: 'Which resource to act on'
        required: true
        default: 'all'
        type: choice
        options:
          - ec2
          - s3
          - all
      backend_bucket:
        description: 'S3 bucket to store tfstate (create it with backend-bootstrap)'
        required: true
        type: string
      recipient_email:
        description: 'Recipient email for deployment results'
        required: true
        type: string

permissions:
  contents: read

jobs:
  terraform:
    runs-on: ubuntu-latest
    env:
      TF_IN_AUTOMATION: true
    steps:
      - uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: '1.5.0'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-south-1

      - name: Determine actions
        id: params
        run: |
          echo "destroy=${{ github.event.inputs.destroy }}" >> $GITHUB_OUTPUT
          echo "resource=${{ github.event.inputs.resource }}" >> $GITHUB_OUTPUT
          echo "backend_bucket=${{ github.event.inputs.backend_bucket }}" >> $GITHUB_OUTPUT
          echo "recipient_email=${{ github.event.inputs.recipient_email }}" >> $GITHUB_OUTPUT

      - name: Run action for selected resources
        id: run_terraform
        run: |
          set -eux
          DESTROY="${{ steps.params.outputs.destroy }}"
          RESOURCE="${{ steps.params.outputs.resource }}"
          BUCKET="${{ steps.params.outputs.backend_bucket }}"

          apply_dirs=()
          if [ "$RESOURCE" = "ec2" ] || [ "$RESOURCE" = "all" ]; then
            apply_dirs+=("ec2")
          fi
          if [ "$RESOURCE" = "s3" ] || [ "$RESOURCE" = "all" ]; then
            apply_dirs+=("s3")
          fi

          for d in "${apply_dirs[@]}"; do
            echo "Working on module: $d"
            # create backend.hcl per module
            cat > $d/backend.hcl <<EOF
bucket = "${BUCKET}"
key    = "${d}/terraform.tfstate"
region = "ap-south-1"
encrypt = true
EOF

            pushd $d
            terraform init -backend-config=backend.hcl
            if [ "$DESTROY" = "true" ]; then
              terraform destroy -auto-approve
            else
              terraform apply -auto-approve
            fi
            terraform output -json > ../${d}_outputs.json || true
            popd
          done
        shell: bash

      - name: Send email with results
        if: always()
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install python deps and send email
        if: always()
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          RECIPIENT: ${{ github.event.inputs.recipient_email }}
        run: |
          python -m pip install --upgrade pip
          python -m pip install email-validator
          python - <<'PY'
import os, json, smtplib
from email.message import EmailMessage

recipient = os.environ.get('RECIPIENT')
smtp_server = os.environ.get('SMTP_SERVER')
smtp_port = int(os.environ.get('SMTP_PORT') or 587)
smtp_user = os.environ.get('SMTP_USER')
smtp_password = os.environ.get('SMTP_PASSWORD')

parts = []
for f in ('ec2_outputs.json','s3_outputs.json'):
    if os.path.exists(f):
        try:
            data = json.load(open(f))
            parts.append(f'--- {f} ---\n')
            parts.append(json.dumps(data, indent=2))
        except Exception as e:
            parts.append(f'Could not read {f}: {e}\n')

body = 'Terraform run completed.\n\n' + ('\n\n'.join(parts) if parts else 'No outputs found.')

msg = EmailMessage()
msg['Subject'] = 'Terraform run results'
msg['From'] = smtp_user
msg['To'] = recipient
msg.set_content(body)

if smtp_server and smtp_user and smtp_password:
    s = smtplib.SMTP(smtp_server, smtp_port, timeout=30)
    s.starttls()
    s.login(smtp_user, smtp_password)
    s.send_message(msg)
    s.quit()
else:
    print('SMTP not configured; printing email body:')
    print(body)
PY
