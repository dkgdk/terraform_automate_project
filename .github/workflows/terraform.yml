name: Terraform Workflow

on:
  workflow_dispatch:
    inputs:
      destroy:
        type: choice
        description: "Destroy resources?"
        default: "no"
        options: ["no","yes"]

      resource:
        type: choice
        description: "Select resource type"
        default: "ec2"
        options: ["ec2","s3","all"]

      backend_bucket:
        description: "S3 bucket name used for Terraform remote state (create from backend module first)"
        required: true

      recipient_email:
        description: "Email to receive results"
        required: true
        default: "durgeshgupt.dg@gmail.com"

jobs:
  terraform:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: "ap-south-1"
      BACKEND_BUCKET: ${{ github.event.inputs.backend_bucket }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Decide modules
        id: modules
        run: |
          echo "Requested resource: ${{ github.event.inputs.resource }}"
          if [ "${{ github.event.inputs.resource }}" = "all" ]; then
            echo "modules=ec2 s3" >> $GITHUB_OUTPUT
          else
            echo "modules=${{ github.event.inputs.resource }}" >> $GITHUB_OUTPUT
          fi

      - name: Loop modules (init/plan/apply/destroy) and check state in S3
        id: loop
        run: |
          set -euo pipefail
          IFS=' ' read -r -a mods <<< "${{ steps.modules.outputs.modules }}"
          for m in "${mods[@]}"; do
            echo "=== Working on module: $m ==="
            PUSH_DIR="$m"
            BACKEND_KEY="$m/terraform.tfstate"
            echo "Checking if state exists: s3://${{ env.BACKEND_BUCKET }}/${BACKEND_KEY}"
            if aws s3 ls "s3://${{ env.BACKEND_BUCKET }}/${BACKEND_KEY}" ; then
              echo "state_exists=true" >> $GITHUB_ENV
              echo "Found existing state for ${m}"
            else
              echo "state_exists=false" >> $GITHUB_ENV
              echo "No state file found for ${m}; this will be a fresh deployment"
            fi

            cd "$PUSH_DIR"

            terraform init -input=false -backend-config="bucket=${{ env.BACKEND_BUCKET }}" -backend-config="key=${BACKEND_KEY}" -backend-config="region=${{ env.AWS_REGION }}" -reconfigure

            if [ "${{ github.event.inputs.destroy }}" = "yes" ]; then
              echo "Destroying resources for module ${m}..."
              terraform destroy -auto-approve || true
            else
              echo "Planning and applying for module ${m}..."
              terraform plan -out=tfplan -input=false
              terraform apply -auto-approve tfplan
            fi

            if [ "${{ github.event.inputs.destroy }}" = "no" ]; then
              terraform output -json > ../${m}_outputs.json || true
            fi
            cd ..
          done

      - name: Upload PEM artifact (if exists)
        uses: actions/upload-artifact@v4
        with:
          name: ec2-private-key
          path: ec2/tf-key.pem
          if-no-files-found: ignore

      - name: Send Email with outputs
        if: always()
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          RECIPIENT: ${{ github.event.inputs.recipient_email }}
        run: |
          echo "Preparing email body..."
          BODY="Terraform Workflow Results\n\n"
          for f in ec2_outputs.json s3_outputs.json; do
            if [ -f "$f" ]; then
              BODY+="--- $f ---\n"
              BODY+=$(cat $f)
              BODY+="\n\n"
            fi
          done
          BODY+="PEM artifact (if created) available in workflow artifacts."
          echo -e "$BODY" > email_body.txt

          # send via curl (requires SMTP secrets)
          curl --ssl-reqd --url "smtp://${SMTP_SERVER}:${SMTP_PORT}" --user "${SMTP_USER}:${SMTP_PASSWORD}"                     --mail-from "${SMTP_USER}" --mail-rcpt "${RECIPIENT}" --upload-file email_body.txt || true
